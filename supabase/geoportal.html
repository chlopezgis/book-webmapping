<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>LuGIS Geoportal - VersiÃ³n Total Unificada</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  :root {
    --verde-lugis: #1a7a6b;
    --dorado-lugis: #d4af37;
    --oscuro-modal: #111827;
    --oscuro-input: #1f2937;
  }

  * { box-sizing: border-box; }
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; overflow: hidden; }

  #sidebar {
    position: fixed; top:0; left:0; width:320px; height:100vh;
    background: white; border-right: 1px solid #ddd; padding: 20px;
    overflow-y: auto; z-index: 1500; box-shadow: 4px 0 15px rgba(0,0,0,0.05);
  }

  #map { margin-left: 320px; width: calc(100% - 320px); height: 100vh; background: #eee; }

  /* BUSCADOR FLOTANTE */
  .search-container { position: relative; margin-bottom: 20px; }
  #autocomplete {
    position: absolute; top: 100%; left: 0; right: 0;
    list-style: none; padding: 0; margin: 0;
    background: white; border: 1px solid #ddd; z-index: 3000;
    max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-radius: 0 0 8px 8px;
  }
  #autocomplete li { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
  #autocomplete li:hover { background: #f8f9fa; color: var(--verde-lugis); font-weight: bold; }

  /* SECCIONES SIDEBAR */
  .section-header {
    display: flex; align-items: center; gap: 8px; padding: 12px 0;
    font-weight: bold; color: #2d3748; border-bottom: 2px solid var(--verde-lugis); margin-bottom: 10px;
  }
  .stats-card { background: var(--verde-lugis); color: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
  .stats-item { display: flex; justify-content: space-between; margin: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }

  /* MODAL ESTILO LUGIS */
  .modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 4000; align-items: center; justify-content: center;
  }
  .modal-box {
    background: var(--oscuro-modal); width: 450px; padding: 25px; border-radius: 15px; 
    color: white; border: 2px solid var(--verde-lugis);
  }
  .input-form { width: 100%; background: var(--oscuro-input); border: 1px solid #4b5563; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; outline: none; }
  
  .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
  .btn-form { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }

  #btnNuevaIncidencia {
    position: fixed; bottom: 20px; right: 20px;
    background: var(--verde-lugis); color: white; border: none; padding: 14px 28px;
    border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 2000; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  /* GESTIÃ“N DE CAPAS */
  .layer-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
  .switch { position: relative; width: 34px; height: 18px; display: inline-block; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 20px; transition: .4s; }
  .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
  input:checked + .slider { background-color: var(--dorado-lugis); }
  input:checked + .slider:before { transform: translateX(16px); }

  /* MODO REPORTE ACTIVO */
  .modo-reporte-activo .leaflet-interactive[fill*="#1a7a6b"] { pointer-events: none !important; }
</style>
</head>

<body>

<div id="sidebar">
  <div style="text-align: center; margin-bottom: 20px;">
    <h2 style="color:var(--verde-lugis); border-bottom: 2px solid var(--dorado-lugis); display: inline-block;">LuGIS</h2>
  </div>
  
  <div class="search-container">
    <input id="searchBarrios" placeholder="ðŸ” Buscar barrio..." style="width:100%; padding:12px; border-radius:8px; border:1px solid #ddd;" autocomplete="off"/>
    <ul id="autocomplete"></ul>
  </div>

  <div id="sectionStats" style="display:none;">
    <div class="section-header"><i class="fa-solid fa-chart-pie"></i> EstadÃ­sticas Barrio</div>
    <div class="stats-card">
        <h4 id="statsTitle" style="margin:0 0 10px 0; color: var(--dorado-lugis);">Barrio</h4>
        <div class="stats-item"><span>PolicÃ­as</span> <b id="statPoli">-</b></div>
        <div class="stats-item"><span>Bomberos</span> <b id="statBomb">-</b></div>
        <div class="stats-item"><span>Salud</span> <b id="statSalud">-</b></div>
        <div class="stats-item" style="color:var(--dorado-lugis); font-weight: bold;"><span>Reportes</span> <b id="statIncidencias">-</b></div>
        <div class="stats-item"><span>Alcantarillado</span> <b id="statAlcan">-</b></div>
        <button onclick="location.reload()" style="width:100%; padding:8px; background:var(--oscuro-modal); color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">Limpiar Filtros</button>
    </div>
  </div>

  <div class="section-header"><i class="fa-solid fa-layer-group"></i> Capas del Mapa</div>
  <div id="layersContainer"></div>
</div>

<div id="map"></div>

<button id="btnNuevaIncidencia" onclick="abrirModal()">
    <i class="fa-solid fa-circle-exclamation"></i> NUEVA INCIDENCIA
</button>

<div class="modal-overlay" id="modalReporte">
    <div class="modal-box">
        <h3><i class="fa-solid fa-bullhorn"></i> Generar Reporte</h3>
        
        <label style="font-size:12px; color:var(--dorado-lugis)">Nombre Completo</label>
        <input type="text" id="repNombre" class="input-form" placeholder="Tu nombre...">
        
        <label style="font-size:12px; color:var(--dorado-lugis)">Tipo de Problema</label>
        <select id="repTipo" class="input-form">
            <option value="Seguridad">Seguridad</option>
            <option value="Agua Potable">Agua Potable</option>
            <option value="Alcantarillado">Alcantarillado</option>
            <option value="VÃ­a PÃºblica">VÃ­a PÃºblica</option>
        </select>

        <label style="font-size:12px; color:var(--dorado-lugis)">Comentarios adicionales</label>
        <textarea id="repDesc" class="input-form" style="height:70px; resize:none;"></textarea>
        
        <label style="font-size:12px; color:var(--dorado-lugis)">UbicaciÃ³n del Incidente</label>
        <div class="btn-group">
            <button class="btn-form" style="background: #2d3748; color: var(--dorado-lugis); border: 1px solid var(--dorado-lugis);" onclick="usarGPS()">
                <i class="fa-solid fa-location-crosshairs"></i> Usar GPS
            </button>
            <button class="btn-form" style="background: var(--verde-lugis); color: white;" onclick="activarSeleccionMapa()">
                <i class="fa-solid fa-map-pin"></i> Marcar Mapa
            </button>
        </div>

        <button class="btn-form" style="background:#4b5563; color: white; width: 100%;" onclick="cerrarModal()">Cancelar</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SUPABASE_URL = "https://lhlpjcrndlnjtfhjdubq.supabase.co/rest/v1/";
const SUPABASE_KEY = "sb_publishable_7HVSX3_sQ11Ll1fkQP9YCg_BuKdMewh";
const headers = { "apikey": SUPABASE_KEY, "Authorization": "Bearer " + SUPABASE_KEY };

// INICIALIZACIÃ“N DE MAPAS BASE
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
const light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

const map = L.map('map').setView([-4.0, -79.2], 14);
osm.addTo(map);

L.control.layers({  "Standard": osm, "Claro": light, "Oscuro": dark, "Satelital": sat }, null, { position: 'topright' }).addTo(map);

// DEFINICIÃ“N DE CAPAS DESDE BASE DE DATOS
const capasDef = [
  { tabla: "barrios", nombre: "Barrios", icon: "fa-draw-polygon", color: "#1a7a6b" },
  { tabla: "incidencias", nombre: "Reportes", icon: "fa-triangle-exclamation", color: "#f56565" },
  { tabla: "agua_potable", nombre: "Agua Potable", icon: "fa-droplet", color: "#3182ce" },
  { tabla: "alcantarillado", nombre: "Alcantarillado", icon: "fa-faucet-drip", color: "#805ad5" },
  { tabla: "bomberos_wgs84", nombre: "Bomberos", icon: "fa-fire", color: "#e53e3e" },
  { tabla: "policias_wgs84", nombre: "PolicÃ­a", icon: "fa-shield", color: "#2b6cb0" },
  { tabla: "salud_wgs84", nombre: "Salud", icon: "fa-kit-medical", color: "#38a169" }
];

let barriosCache = [];
let modoSeleccion = false;
let marcadorTemp = null;
let capaHighlight = null;

async function cargarGeoportal() {
  const container = document.getElementById("layersContainer");
  for (const c of capasDef) {
    const div = document.createElement("div");
    div.className = "layer-item";
    div.innerHTML = `<span><i class="fa-solid ${c.icon}" style="color:${c.color}"></i> ${c.nombre}</span>
      <label class="switch"><input type="checkbox" id="chk-${c.tabla}" onchange="toggleCapa('${c.tabla}')"><span class="slider"></span></label>`;
    container.appendChild(div);

    try {
      const res = await fetch(`${SUPABASE_URL}${c.tabla}?select=geom,*`, { headers });
      const data = await res.json();
      const layer = L.geoJSON(data.map(d => ({
        type: "Feature", geometry: typeof d.geom === 'string' ? JSON.parse(d.geom) : d.geom, properties: d
      })), {
        style: { color: c.color, weight: 3, fillOpacity: 0.2 },
        pointToLayer: (f, ll) => L.circleMarker(ll, { radius: 6, fillColor: c.color, color: "#fff", weight: 1, fillOpacity: 0.8 }),
        onEachFeature: (f, l) => {
          let pop = `<div style="font-size:12px"><b>Detalle de ${c.nombre}</b><hr>`;
          for (let k in f.properties) if (k !== 'geom' && f.properties[k]) pop += `<b>${k}:</b> ${f.properties[k]}<br>`;
          l.bindPopup(pop + `</div>`);

          if (c.tabla === "barrios") {
            l.on('click', (e) => { if(!modoSeleccion) { L.DomEvent.stopPropagation(e); seleccionarBarrio(f.properties); } });
          }
        }
      });
      window[`layer_${c.tabla}`] = layer;
      if (c.tabla === "barrios") { barriosCache = data; layer.addTo(map); document.getElementById("chk-barrios").checked = true; }
    } catch (e) { console.error("Error en " + c.tabla, e); }
  }
}

function toggleCapa(t) {
  const l = window[`layer_${t}`];
  if (document.getElementById(`chk-${t}`).checked) l.addTo(map);
  else if (l) map.removeLayer(l);
}

// BUSCADOR REPARADO
const searchInput = document.getElementById("searchBarrios");
const autoList = document.getElementById("autocomplete");
searchInput.addEventListener("input", () => {
  const val = searchInput.value.toLowerCase();
  autoList.innerHTML = "";
  if (!val) return;
  barriosCache.filter(b => b.barrio.toLowerCase().includes(val)).slice(0,6).forEach(b => {
    const li = document.createElement("li");
    li.textContent = b.barrio;
    li.onclick = () => { searchInput.value = b.barrio; autoList.innerHTML = ""; seleccionarBarrio(b); };
    autoList.appendChild(li);
  });
});
document.addEventListener("click", (e) => { if (e.target !== searchInput) autoList.innerHTML = ""; });

async function seleccionarBarrio(b) {
  if (capaHighlight) map.removeLayer(capaHighlight);
  const g = typeof b.geom === 'string' ? JSON.parse(b.geom) : b.geom;
  capaHighlight = L.geoJSON(g, { style: { color: 'var(--dorado-lugis)', weight: 5, fillOpacity: 0.3 } }).addTo(map);
  map.fitBounds(capaHighlight.getBounds());
  document.getElementById("sectionStats").style.display = "block";
  document.getElementById("statsTitle").textContent = b.barrio;
  const res = await fetch(`${SUPABASE_URL}rpc/obtener_estadisticas_barrio`, {
    method: 'POST', headers: { ...headers, "Content-Type": "application/json" },
    body: JSON.stringify({ nombre_barrio_buscado: b.barrio })
  });
  const d = await res.json();
  const s = d[0];
  if(s) {
    document.getElementById("statPoli").textContent = s.conteo_policias;
    document.getElementById("statBomb").textContent = s.conteo_bomberos;
    document.getElementById("statSalud").textContent = s.conteo_salud;
    document.getElementById("statIncidencias").textContent = s.conteo_incidencias;
    document.getElementById("statAlcan").textContent = (s.longitud_alcantarillado/1000).toFixed(2)+" km";
  }
}

// REPORTES Y GPS
function abrirModal() { document.getElementById("modalReporte").style.display = "flex"; }
function cerrarModal() { document.getElementById("modalReporte").style.display = "none"; }

function usarGPS() {
  if (!navigator.geolocation) return alert("GPS no soportado");
  navigator.geolocation.getCurrentPosition((pos) => {
    cerrarModal();
    const { latitude, longitude } = pos.coords;
    map.setView([latitude, longitude], 17);
    colocarMarcador(latitude, longitude);
  }, () => alert("Permiso de GPS denegado."));
}

function activarSeleccionMapa() {
  modoSeleccion = true; cerrarModal();
  document.body.classList.add('modo-reporte-activo');
  document.getElementById("map").style.cursor = "crosshair";
  document.getElementById("btnNuevaIncidencia").innerHTML = "CANCELAR MARCADO";
  document.getElementById("btnNuevaIncidencia").onclick = cancelarReporte;
}

function cancelarReporte() {
  modoSeleccion = false; document.body.classList.remove('modo-reporte-activo');
  document.getElementById("map").style.cursor = "";
  document.getElementById("btnNuevaIncidencia").innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> NUEVA INCIDENCIA';
  document.getElementById("btnNuevaIncidencia").onclick = abrirModal;
  if(marcadorTemp) map.removeLayer(marcadorTemp);
}

map.on('click', (e) => { if (modoSeleccion) colocarMarcador(e.latlng.lat, e.latlng.lng); });

function colocarMarcador(lat, lng) {
  if (marcadorTemp) map.removeLayer(marcadorTemp);
  marcadorTemp = L.marker([lat, lng]).addTo(map)
    .bindPopup(`<b>Â¿Enviar aquÃ­?</b><br><button onclick="guardarFinal(${lat},${lng})" style="background:var(--verde-lugis); color:white; border:none; padding:8px; width:100%; margin-top:5px; border-radius:4px; cursor:pointer;">CONFIRMAR</button>`)
    .openPopup();
}

async function guardarFinal(lat, lng) {
  const payload = {
    categoria: document.getElementById("repTipo").value,
    descripcion: `Reporte de ${document.getElementById("repNombre").value}: ${document.getElementById("repDesc").value}`,
    geom: `POINT(${lng} ${lat})`
  };
  await fetch(`${SUPABASE_URL}incidencias`, { method: 'POST', headers: { ...headers, "Content-Type": "application/json" }, body: JSON.stringify(payload) });
  alert("Reporte exitoso");
  location.reload();
}

cargarGeoportal();
</script>
</body>
</html>